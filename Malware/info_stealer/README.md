# info_stealer

## 機能
- Chromeに保存されているパスワード抽出
- AES-256-GCMの復号
- HTTPS通信による持ち出し
- 実行後の自己消去

## 処理
1. ターゲットの`Local State`ファイル(json)からbase64エンコードされた`encrypted_key`を抽出。
2. `encrypted_key`からマジックナンバーを除去し、`DPAPI`である`CryptUnprotectData`を使用して`マスターキー`を復号する。
3. `Login Data`ファイル(SQLite)を`C:\tmp`へ一時退避する。
4. SQLiteファイルを開き、SQLで`URL`、`ユーザー名`、`暗号化されたパスワード`を取得する。
5. Chromeは`AES-256-GCM`方式で暗号化しているため、2で得た`マスターキー`と4で取得した`暗号化されたパスワード`にある`iv`と`auth tag`を使って復号する。
6. `c2_server.py`を起動し、データは`data.txt`で受け取る。
7. 復号した情報を`https`でc2サーバーへhttpsで送信する。
8. 実行後、自身のプログラムと退避した`Login Data`を消去する。

## 実行までの手順
1. 攻撃者側で自己署名証明書である`server.pem`を生成。
```bash
openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes
```
2. `c2_server.py`を実行。
3. ターゲットで`info_stealer.exe`を実行
```powershell
# ビルド
gcc -O2 -static -o info_stealer info_stealer.c sqlite3.c -lcrypt32 -lbcrypt -lwininet -mwindows
```

## ナレッジ
- `AES-256-GCM`は`aes鍵`, `iv`, `auth tag`で復号する。
- Chromeのデータは`Local State`にある`encrypted_key`が`aes鍵`の元であり、`DPAPI`である`CryptUnprotectData`を使用することで`aes鍵`が得られる。
- `AES`とは16byteごとに暗号化を行うアルゴリズム
- `AES-128`は128ビット(16byte)の鍵で11回の暗号処理を行う
- `AES-256`は256ビット(32byte)の鍵で14回の暗号処理を行う
- `CBC`は`Cipher Block Chain`の略で、前回の暗号処理結果を次回の暗号処理に使う。初回のみIV(16byte)を使用する。
- `GCM`は暗号化と改ざん防止を同時に行う。`GCM`は並列処理が可能で高速だが複雑。